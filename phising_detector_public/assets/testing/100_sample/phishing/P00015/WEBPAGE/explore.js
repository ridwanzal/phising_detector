define(["underscore","backbone","jquery"],function(e,t,n){"use strict";var r=t.View.extend({el:"body",elms:{contentBlock:n("#content"),exploreModal:n(".exploreModal"),exploreModalBtn:n(".exploreModal").find("button"),overlay:n("<div />"),bubbleWidth:164,relativePosition:[],counter:0},initialize:function(e){if(!this.$el.hasClass("explore"))return;this.elms.counter=0,this.elms.relativePosition=[],function(e){n(window).on("resize scroll.updatePosition",function(){e.$el.hasClass("explore")&&e.positionBubble(e)})}(this),this.wrapByOverlay(),this.elms.exploreModal.addClass("loadingGray"),this.viewLoadingCheck(),n(this.elms.overlay).add(this.elms.exploreModalBtn).click(n.proxy(function(){this.$el.removeClass("explore"),this.removeOverlayElements(),this.options.ajaxUrl&&n.get(this.options.ajaxUrl)},this)),n(document).keyup(n.proxy(function(e){e.keyCode===27&&(this.removeOverlayElements(),this.options.ajaxUrl&&n.get(this.options.ajaxUrl))},this))},removeOverlayElements:function(){this.elms.contentBlock.length>0&&this.elms.contentBlock.removeAttr("aria-hidden"),this.elms.exploreModal.hide(),this.elms.overlay.remove(),this.elms.exploreModalBtn.off("click"),n(window).off("resize scroll.updatePosition"),this.$el.off("viewLoaded"),this.options.wrapBubblesById?n("#"+this.options.wrapBubblesById).remove():this.getBubbles().remove()},getBubblesContent:function(){var e=n();return n.each(n("*[data-explore], *[data-explore-sticky]"),function(t,r){var i=n(r).data("explore")||n(r).data("explore-sticky");n(r).is(":visible")&&n.trim(i).length>0&&e.push(r)}),e},getBubbles:function(){return n(".exploreBubble")},wrapByOverlay:function(){this.elms.contentBlock.length>0&&this.elms.contentBlock.attr("aria-hidden","true"),this.elms.overlay=n("<div />",{"class":"exploreOverlay",css:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"#000","z-index":2e3}}).fadeTo(250,.22).appendTo(this.$el),this.elms.exploreModal.fadeTo(250,1),this.elms.exploreModalBtn.focus()},viewLoadingCheck:function(){var e=this.options.onViewLoaded;this.$el.css("overflow","scroll");if((!e||!n.isArray(e)||e.length===0)&&this.$el.hasClass("explore")){this.drawBubble(n.makeArray(this.getBubblesContent()));return}this.$el.on("viewLoaded",n.proxy(function(t,r){var i=0;e[n.inArray(r,e)]=1,n.each(e,function(e,t){i+=t===1?1:0}),i===e.length&&this.$el.hasClass("explore")&&this.viewsLoaded()},this))},viewsLoaded:function(){var t=350,r=n.makeArray(this.getBubblesContent()),i=[],s=this,o=setInterval(function(){if(!n(".exploreModal").is(":visible")){clearInterval(o);return}i=e.difference(n.makeArray(s.getBubblesContent()),r),i.length>0&&(r=e.union(r,i),s.drawBubble(i))},t);this.$el.css("overflow","auto"),n(".exploreModal").is(":visible")&&this.drawBubble(r)},drawBubble:function(e){var t=this,r=t.$el;t.options.wrapBubblesById&&(n("#"+t.options.wrapBubblesById).length<1?r=n("<div />",{id:this.options.wrapBubblesById}).appendTo(t.$el):r=n("#"+t.options.wrapBubblesById)),n.each(e,function(e,i){var s=n(i).data("explore")||n(i).data("explore-sticky"),o=n(i).offset().left,u=n(i).offset().top,a=o+n(i).outerWidth()/2-t.elms.bubbleWidth/2-10,f=u+n(i).outerHeight()+12,l="",c,h="exploreBubble_"+t.elms.counter++;t.options[h]&&(a+=t.options[h].left,f+=t.options[h].top,t.options[h].arrow&&(l=" "+t.options[h].arrow)),r.append(c=n("<div />",{id:h,"class":"exploreBubble"+l,html:s,css:{left:parseInt(a,10),top:parseInt(f,10)}})),t.options[h]&&t.options[h].arrow==="bottomCenter"&&c.css("top",parseInt(f,10)-c.outerHeight()),t.elms.relativePosition.push({left:a-o,top:f-u})}),this.elms.exploreModal.removeClass("loadingGray")},positionBubble:function(e){var t=e.getBubblesContent(),r=768;n.each(t,function(t,i){var s=n("#exploreBubble_"+t);e.elms.relativePosition[t]&&s.is(":visible")&&(s.css({visibility:n(window).width()>r?"visible":"hidden",left:parseInt(n(i).offset().left+e.elms.relativePosition[t].left,10)}),n(i).attr("data-explore-sticky")&&s.css("top",parseInt(n(i).offset().top+e.elms.relativePosition[t].top,10)))})}});return r})