/*
 checkEntry 1.1.1 
 Copyright(c) 2014 Rakuten.Inc
 Date: 2014-04-25 16:12:44
*/
(function(j,e){if(j.jQuery!==e){jQuery.noConflict();var g=jQuery;if(g.RJS_Helpers){var k=function(){var a=this;g.extend(a,{settings:{jsonurl:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],ajaxtimeout:[3,"Range","1,99"],campaignid:["","Str","^([0-9,]+)$"],testmodealert:[1,"Int","^[01]$"]},eobj:{checkentry:null,config:null,alreadyentry:null,nonentry:null},status:{isTimeout:!1},localStorage:{key:"",alreadyEntryList:null,garbageKey:"checkEntryGarbageTimer",
expireIn:604800,isSupport:!0},initialize:function(c){a.eobj.checkentry=c;a.eobj.config=c.find(".checkEntryConfig");a.eobj.nonentry=c.find(".nonEntryBanner");a.eobj.alreadyentry=c.find(".alreadyEntryBanner");c=location.search.match(/checkentry=(already|nonentry)/);if(null!==c)a.beginTestMode(c[1]);else if(0!=a.eobj.alreadyentry.length)if(0==a.eobj.config.length)a.showNonEntry();else{var b;try{localStorage.setItem("localStorageTest","1"),localStorage.removeItem("localStorageTest"),b=!0}catch(d){b=!1}if(!b||
"undefined"==typeof JSON)a.localStorage.isSupport=!1;a.getSettings()&&a.begin()}},beginTestMode:function(c){"already"===c?a.showAlreadyEntry():"nonentry"===c&&a.showNonEntry();var b=a.getSettings();if(1==a.settings.testmodealert){var c="already"===c?"エントリー済み":"未エントリー",d=a.eobj.checkentry.attr("id");alert("テストモード　:　"+c+"\n\nチェック対象　:　"+d+"\ncheckEntryConfig設定　:　"+(b?"OK":"NG⇒確認してください")+"\nエントリー済み要素　:　"+(0<a.eobj.alreadyentry.length?"有り":"無し⇒確認してください")+"\n未エントリー要素　:　"+(0<a.eobj.nonentry.length?"有り":
"無し⇒確認してください")+"\n設定されているキャンペーンID　:　"+a.settings.campaignid)}},indexOf:function(a,b){for(var d=0;d<a.length;d++)if(a[d]===b)return d;return-1},getSettings:function(){a.settings=g.RJS_Helpers.readAttr(a.eobj.config,a.settings);if(""==a.settings.jsonurl||""==a.settings.campaignid)return!1;a.settings.ajaxtimeout*=1E3;a.eobj.config.remove();return!0},getLocalStorage:function(){a.localStorage.alreadyEntryList=localStorage[a.localStorage.key]==e?[]:JSON.parse(localStorage[a.localStorage.key]);return a},
setGarbageTimer:function(){var c,b=a.localStorage.garbageKey,d=(new Date).getTime();c=localStorage[b]==e?JSON.parse("{}"):JSON.parse(localStorage[b]);for(obj in c)(d-c[obj])/1E3>a.localStorage.expireIn&&(localStorage.removeItem(obj),delete c[obj]);c[a.localStorage.key]==e&&(c[a.localStorage.key]=d);localStorage[b]=JSON.stringify(c)},getCookie:function(a){var b,d,h,f=document.cookie.split(";");for(b=0;b<f.length;b++)if(d=f[b].substr(0,f[b].indexOf("=")),h=f[b].substr(f[b].indexOf("=")+1),d=d.replace(/^\s+|\s+$/g,
""),d==a)return unescape(h)},isAlreadyEntry:function(){for(var c=a.settings.campaignid.split(","),b=a.localStorage.alreadyEntryList,d=0;d<c.length;d++)if(c[d]=parseInt(c[d]),-1!=a.indexOf(b,c[d]))return!0;return!1},begin:function(){if(a.getCookie("Rz")!=e)a.localStorage.isSupport?(a.localStorage.key="checkentry-"+a.getCookie("Rz").substr(23,8),a.setGarbageTimer(),a.getLocalStorage(),0<a.localStorage.alreadyEntryList.length&&a.isAlreadyEntry()?a.showAlreadyEntry():a.getData()):a.getData()},getData:function(){var c;
a.status.isTimeout=!1;try{c=setTimeout(function(){a.status.isTimeout=!0;a.showNonEntry()},a.settings.ajaxtimeout),g.ajax({url:a.settings.jsonurl,dataType:"jsonp",timeout:a.settings.ajaxtimeout,data:{n:encodeURIComponent(a.settings.campaignid)},success:function(d){if(!a.status.isTimeout){clearTimeout(c);var b,f=!1;if(null==d||"200"!=d.code)a.showNonEntry();else{a.localStorage.isSupport&&a.getLocalStorage();for(var e=0;e<d.results.length;e++)b=d.results[e],b.c_id=parseInt(b.c_id),b.result=parseInt(b.result),
1==b.result&&(a.localStorage.isSupport&&-1==a.indexOf(a.localStorage.alreadyEntryList,b.c_id)&&a.localStorage.alreadyEntryList.push(b.c_id),f=!0);f?a.showAlreadyEntry():a.showNonEntry();a.localStorage.isSupport&&(localStorage[a.localStorage.key]=JSON.stringify(a.localStorage.alreadyEntryList))}}},error:function(){a.showNonEntry();a.status.isTimeout=!0}})}catch(b){return a.showNonEntry(),!1}},showAlreadyEntry:function(){a.eobj.nonentry.hide();a.eobj.alreadyentry.show()},showNonEntry:function(){a.eobj.nonentry.show();
a.eobj.alreadyentry.hide()}})},l=1;do{var i=g("#checkEntry"+l++);if(0==i.length)break;(new k).initialize(i)}while(1)}}})(this);
