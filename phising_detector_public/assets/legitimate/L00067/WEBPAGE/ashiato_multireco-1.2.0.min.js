/*
 ashiato_multireco.js 1.2.0
 Copyright (c) 2013 Rakuten.Inc
 Date : 2013-12-12 10:59:06
*/
(function(h,g){if(h.jQuery!==g){jQuery.noConflict();var b=jQuery;b.RJS_Helpers&&b().RJS_Slideshow&&(new function(){var a=this;b.extend(a,{settings:{common:{noready:[0,"Int","^[0-1]$"],pagespeed:[100,"Range","0,9999"],opacityspeed:[100,"Range","0,9999"],autoslidetime:[2,"Range","1,99"],autoslideflag:["next","Str","^(next|prev)$"],autoslide:[0,"Int","^[0-1]$"],autoresize:[1,"Int","^[0-1]$"],impvar:["","Str","^[a-zA-Z0-9_]{3,64}$"],impdisp:["","Str","^[a-zA-Z0-9_]{3,64}$"],impnodisp:["","Str","^[a-zA-Z0-9_]{3,64}$"],
verticalmode:[0,"Int","^[1]$"],ajaxtimer:[3,"Range","1,99"],recothreshold:[5,"Int","^[1-9]$"],rankingshuffle:[1,"Int","^[0-1]$"],requestwait:[500,"Range","1,9999"],checkinterval:[100,"Range","1,9999"],genrefilter:["551169","Str","^[0-9,]{1,69}$"]},ashiato:{imagesize:["80x80","Str","^[1-9]{1}[0-9]{1,2}x[1-9]{1}[0-9]{1,2}"],omitname:[26,"Range","0,100"],maxitem:[1,"Int","^[1-9]$"],url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],sid:["",
"Str","^[a-zA-Z0-9_\\-]{3,64}$"]},reco:{imagesize:["80x80","Str","^[1-9]{1}[0-9]{1,2}x[1-9]{1}[0-9]{1,2}"],omitname:[26,"Range","0,100"],maxitem:[3,"Int","^[1-9]$"],url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"]},ranking:{url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],genrelayer:[2,"Int","^[1-9]$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"]}},
eobj:{common:{config:b("#ashiatoRecoCommonConfig"),existItem:b("#ashiatoRecoExistItemDisplay"),altContents:b("#ashiatoRecoAlteredContents"),recoSlider:b("#ashiatoRecoRecoSlider"),loading:b("#ashiatoRecoLoading")},ashiato:{config:b("#ashiatoRecoAshiatoConfig"),prevButton:b("#ashiatoRecoCheckPrevButton"),nextButton:b("#ashiatoRecoCheckNextButton"),proto:b("#prototypeAshiatoRecoAshiatoItem"),itemsDisplay:b("#ashiatoRecoAshiatoItemDisplay")},reco:{config:b("#ashiatoRecoRecoConfig"),prevButton:b("#ashiatoRecoPrevButton"),
nextButton:b("#ashiatoRecoNextButton"),proto:b("#prototypeAshiatoRecoRecoItem"),itemsDisplay:b("#ashiatoRecoRecoItemsDisplay"),altContents:b("#ashiatoRecoRecoAlteredContents")},ranking:{config:b("#ashiatoRecoRankingConfig")}},status:{error:!1,isTimeout:!1},props:{ashiato:{items:[],proto:{html:"",height:0,width:0,identifiers:{itemurl:["",/\#ITEMURL\#/g,""],imageele:['<img src="#ITEMIMGURL#" alt="#ITEMIMGALT#" title="#ITEMIMGTITLE#">',/\#ITEMIMGELE\#/g,""],imageurl:["",/\#ITEMIMGURL\#/g,""],imagealt:["",
/\#ITEMIMGALT\#/g,""],imagetitle:["",/\#ITEMIMGTITLE\#/g,""],itemname:["",/\#ITEMNAME\#/g,""],itemprice:["",/\#ITEMPRICE\#/g,""]}}},reco:{items:[],proto:{html:"",height:0,width:0,identifiers:{itemurl:["",/\#ITEMURL\#/g,""],imageele:['<img src="#ITEMIMGURL#" alt="#ITEMIMGALT#" title="#ITEMIMGTITLE#">',/\#ITEMIMGELE\#/g,""],imageurl:["",/\#ITEMIMGURL\#/g,""],imagealt:["",/\#ITEMIMGALT\#/g,""],imagetitle:["",/\#ITEMIMGTITLE\#/g,""],itemname:["",/\#ITEMNAME\#/g,""],itemprice:["",/\#ITEMPRICE\#/g,""]}}},
currentAshiatoIndex:!1,requestPermission:!0,requestPermissionTimer:null,checkWaitInterval:null,initialized:!1},initialize:function(){a.loadSettings()?1==a.settings.noReady?a.begin():b(document).ready(function(){a.begin()}):a.displayDefaultContents()},loadSettings:function(){a.eobj.ashiato.proto.hide();a.eobj.reco.proto.hide();a.settings.common=b.RJS_Helpers.readAttr(a.eobj.common.config,a.settings.common);a.settings.ashiato=b.RJS_Helpers.readAttr(a.eobj.ashiato.config,a.settings.ashiato);a.settings.reco=
b.RJS_Helpers.readAttr(a.eobj.reco.config,a.settings.reco);a.settings.ranking=b.RJS_Helpers.readAttr(a.eobj.ranking.config,a.settings.ranking);b.extend(a.settings.ashiato,a.settings.common,a.settings.ashiato);b.extend(a.settings.reco,a.settings.common,a.settings.reco);a.settings.ashiato.autoslide=0;a.settings.ashiato.maxitem=1;a.settings.reco.autoslide=0;if(""==a.settings.ashiato.url||512<a.settings.ashiato.url.length||""==a.settings.reco.url||512<a.settings.reco.url.length||""==a.settings.ranking.url||
512<a.settings.ranking.url.length||0===a.eobj.ashiato.proto.length||0===a.eobj.reco.proto.length)return!1;a.settings.common.autoslidetime*=1E3;a.settings.common.ajaxtimer*=1E3;a.eobj.common.config.remove();a.eobj.ashiato.config.remove();a.eobj.reco.config.remove();return!0},displayDefaultContents:function(c){a.eobj.ashiato.proto.remove();a.eobj.reco.proto.remove();a.eobj.common.altContents.show();a.eobj.common.existItem.remove();c&&a.regImpressionCode(c)},displayRecoDefaultContents:function(){a.eobj.common.loading.hide();
a.eobj.common.recoSlider.hide();a.eobj.reco.altContents.show()},displayRecoLoading:function(){a.eobj.reco.altContents.hide();a.eobj.common.altContents.hide();a.eobj.common.recoSlider.hide();a.eobj.common.existItem.show();a.eobj.common.loading.show()},begin:function(){a.getAshiatoData()},getAshiatoData:function(){function c(c){if(a.status.isTimeout)return a.displayDefaultContents(),!1;clearTimeout(d);if(c.code===g||c.num===g)return a.displayDefaultContents(),!1;if("0"!=c.code)return("1"==c.code||"8"==
c.code)&&a.regImpressionCode(a.settings.common.impnodisp),a.displayDefaultContents(),!1;if(1>c.items.length)return a.displayDefaultContents(a.settings.common.impnodisp),!1;for(var b=0;b<c.items.length;b++)/^http:\/\/item.rakuten.co.jp/.test(c.items[b].itemurlfull)&&a.props.ashiato.items.push({itemname:a.editItemname(c.items[b].itemname,a.settings.ashiato.omitname),itemprice:a.editItemprice(c.items[b].itemprice),itemurl:a.editItemurl(c.items[b].itemurlfull,a.settings.ashiato.sid),imageele:"",imageurl:""!=
c.items[b].imageurl?a.editImageurl(c.items[b].imageurl,a.settings.ashiato.imagesize):c.items[b].imageurl64,imagealt:a.editItemname(c.items[b].itemname,a.settings.ashiato.omitname),imagetitle:a.editItemname(c.items[b].itemname,a.settings.ashiato.omitname),mngnumber:c.items[b].mngnumber,shopurl:c.items[b].shopurl,itemid:c.items[b].itemid,shopid:c.items[b].shopid,genreidlist:c.items[b].genreidlist});if(0===a.eobj.ashiato.proto.length)return a.displayDefaultContents(),!1;a.props.ashiato.proto.width=a.eobj.ashiato.proto.outerWidth();
a.props.ashiato.proto.height=a.eobj.ashiato.proto.outerHeight();a.props.ashiato.proto.html=a.eobj.ashiato.proto.html();if(""==a.props.ashiato.proto.html)return a.displayDefaultContents(),!1;a.eobj.ashiato.proto.remove();a.eobj.ashiato.itemsDisplay.RJS_Slideshow(a,{settings:a.settings.ashiato,itemPrototype:a.props.ashiato.proto,eobj:a.eobj.ashiato,items:a.props.ashiato.items,events:{beforeFirstRender:function(a,c){c.eobj.ashiato.itemsDisplay.show()},afterSlide:function(a,c){c.getCachedRecoData(a)||
c.getRecoData(a)}}});a.getRecoData(0)}var d;a.status.isTimeout=!1;try{d=setTimeout(function(){a.status.isTimeout=!0;a.displayDefaultContents()},a.settings.common.ajaxtimer),b.ajax({url:a.settings.ashiato.url,cache:!1,dataType:"jsonp",scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,success:function(a){c(a)},error:function(){a.displayDefaultContents()}})}catch(f){return a.displayDefaultContents(),!1}return!0},getCachedRecoData:function(c){if(!1===c||0==a.props.reco.items.length)return!1;
var b=a.props.reco.items[c];if(b==g||0==b.length)return!1;a.displayRecoLoading();a.displayRecoData(c);return!0},getRecoData:function(c){a.displayRecoLoading();if(a.props.requestPermission){var d;a.status.isTimeout=!1;try{d=setTimeout(function(){a.status.isTimeout=!0;a.getRankingData(c)},a.settings.common.ajaxtimer);var f=a.props.ashiato.items[c];b.ajax({url:a.settings.reco.url,cache:!1,dataType:"jsonp",data:{item_id:f.shopid+"_"+f.itemid},scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,
success:function(b){if(a.status.isTimeout)b=!1;else if(clearTimeout(d),b.status===g||b.item_count===g||"Success"!=b.status&&"NotFound"!=b.status)b=!1;else{for(var f=[],e=0;e<b.item.length;e++)f.push({itemname:a.editItemname(b.item[e].item_name,a.settings.reco.omitname),itemurl:a.editItemurl(b.item[e].item_url,a.settings.reco.sid),imageele:"",imageurl:a.editImageurl(b.item[e].image_url_80,a.settings.reco.imagesize),imagealt:a.editItemname(b.item[e].item_name,a.settings.reco.omitname),imagetitle:a.editItemname(b.item[e].item_name,
a.settings.reco.omitname),itemprice:a.editItemprice(b.item[e].item_price)});a.props.reco.items[c]=f;b=b.item_count<a.settings.common.recothreshold?!1:a.displayRecoData(c)}b||a.getRankingData(c)},error:function(){a.getRankingData(c)}})}catch(e){return a.getRankingData(c),!1}return!0}clearInterval(a.props.checkWaitInterval);a.props.checkWaitInterval=setInterval(function(){a.props.requestPermission&&(clearInterval(a.props.checkWaitInterval),a.getRecoData(c))},a.settings.common.checkinterval)},getRankingData:function(c){function d(c,
d){if(a.status.isTimeout)return!1;clearTimeout(f);if(c.status===g||c.num===g||"Success"!=c.status&&"GenreNotFound"!=c.status)return!1;if(c.num<a.settings.common.recothreshold)return a.regImpressionCode(a.settings.common.impnodisp),!1;for(var e=a.props.ashiato.items[d],h=[],i=0;i<c.items.length;i++){var k=(/R2=([^\&]+)/.exec(c.items[i].itemurl)||[])[1],j=!0;if(k===g&&/^http:\/\/item.rakuten.co.jp/.test(c.items[i].itemurl))j=!1,k=c.items[i].itemurl;k!==g&&(a.endsWith(k,e.shopurl+"/"+e.mngnumber+"/")||
h.push({itemname:a.editItemname(c.items[i].itemname,a.settings.reco.omitname),itemurl:a.editItemurl(c.items[i].itemurl,a.settings.ranking.sid,j),imageele:"",imageurl:a.editImageurl(c.items[i].imageurl64,a.settings.reco.imagesize),imagealt:a.editItemname(c.items[i].itemname,a.settings.reco.omitname),imagetitle:a.editItemname(c.items[i].itemname,a.settings.reco.omitname),itemprice:a.editItemprice(c.items[i].price)}))}if(h.length<a.settings.common.recothreshold)return a.regImpressionCode(a.settings.common.impnodisp),
!1;1===a.settings.common.rankingshuffle&&(h=a.shuffle(h));a.props.reco.items[d]==g&&(a.props.reco.items[d]=[]);a.props.reco.items[d]=b.merge(a.props.reco.items[d],h);return a.displayRecoData(d)}var f;a.status.isTimeout=!1;try{var e=a.props.ashiato.items[c].genreidlist.replace(/^\//,"").split("/"),h=a.settings.common.genrefilter.split(","),j;for(j in h)if(-1!=b.inArray(h[j],e))return a.props.initialized=!0,0<a.props.reco.items[c].length?a.displayRecoData(c):a.displayRecoDefaultContents(),a.props.requestPermission=
!1,a.props.requestPermissionTimer=setTimeout(function(){a.props.requestPermission=!0},a.settings.common.requestwait),!1;e=e[a.settings.ranking.genrelayer];e===g&&(e=0);f=setTimeout(function(){a.status.isTimeout=!0;a.props.initialized?a.displayRecoDefaultContents():a.displayDefaultContents()},a.settings.common.ajaxtimer);b.ajax({url:a.settings.ranking.url,cache:!0,dataType:"jsonp",data:{gid:e},jsonpCallback:"jsonp0123456789012",scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,success:function(b){d(b,
c)||(a.props.initialized?a.displayRecoDefaultContents():a.displayDefaultContents())},error:function(){a.props.initialized?a.displayRecoDefaultContents():a.displayDefaultContents()}})}catch(l){return a.props.initialized?a.displayRecoDefaultContents():a.displayDefaultContents(),!1}return!0},displayRecoData:function(c){if(0===a.eobj.reco.proto.length)return!1;a.props.reco.proto.width=a.eobj.reco.proto.outerWidth();a.props.reco.proto.height=a.eobj.reco.proto.outerHeight();a.props.reco.proto.html=a.eobj.reco.proto.html();
if(""==a.props.reco.proto.html)return!1;a.eobj.reco.proto.hide();a.eobj.reco.itemsDisplay.empty();a.eobj.reco.prevButton.find("a").unbind("click");a.eobj.reco.nextButton.find("a").unbind("click");a.eobj.reco.altContents.hide();a.eobj.common.loading.hide();a.eobj.common.recoSlider.show();a.regImpressionCode(a.settings.common.impdisp);a.eobj.reco.itemsDisplay.RJS_Slideshow(a,{settings:a.settings.reco,itemPrototype:a.props.reco.proto,eobj:a.eobj.reco,items:a.props.reco.items[c],events:{beforeFirstRender:function(a,
c){c.props.initialized=!0;c.eobj.reco.itemsDisplay.show()},afterFirstRender:function(a,c){c.props.requestPermission=!1;c.props.requestPermissionTimer=setTimeout(function(){c.props.requestPermission=!0},c.settings.common.requestwait)}}});return!0},regImpressionCode:function(c){return h[a.settings.common.impvar]===g||""==c?"":h[a.settings.common.impvar]=c},shuffle:function(a){for(var a=Array.apply(null,a),b=a.length;b;){var f=Math.floor(Math.random()*b),e=a[--b];a[b]=a[f];a[f]=e}return a},endsWith:function(a,
b){var f=a.length-b.length;return 0<=f&&a.lastIndexOf(b)===f},editItemname:function(a,d){a=b.RJS_Helpers.omitStr(a,d,"¡Ä");b.browser.msie||(a=a.split("").join(String.fromCharCode(8203)));return a},editItemprice:function(a){return""!=a&&a!==g?(""+a).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"):a},editImageurl:function(a,d){""!=a&&(a=b.RJS_Helpers.urlParameter(a,{_ex:d}));return a},editItemurl:function(a,d,f){""!=d&&(a=f?b.RJS_Helpers.urlR2Parameter(a,{"s-id":d},!1):b.RJS_Helpers.urlParameter(a,{"s-id":d},
!1));return a}})}).initialize()}})(this);
