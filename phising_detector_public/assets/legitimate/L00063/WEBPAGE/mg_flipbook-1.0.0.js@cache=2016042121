var MG_Flipbook=function(){var Self=this,timer,o={},data={},flipTimer;Self.init=function(options){Self.params=options;Self.addEvents()},Self.addEvent=function(element,type,handler){var handlers;if(element.addEventListener){element.addEventListener(type,handler,false)}else{if(!handler.$$guid){handler.$$guid=Self.addEvent.guid++}if(!element.events){element.events={}}handlers=element.events[type];if(!handlers){handlers=element.events[type]={};if(element["on"+type]){handlers[0]=element["on"+type]}}handlers[handler.$$guid]=handler;element["on"+type]=Self.handleEvent}},Self.addEvent.guid=1,Self.removeEvent=function(element,type,handler){if(element.removeEventListener){element.removeEventListener(type,handler,false)}else{if(element.events&&element.events[type]){delete element.events[type][handler.$$guid]}}},Self.handleEvent=function(event){var returnValue=true;event=event||Self.fixEvent(((this.ownerDocument||this.document||this).parentWindow||window).event);var handlers=this.events[event.type];for(var i in handlers){this.$$handleEvent=handlers[i];if(this.$$handleEvent(event)===false){returnValue=false}}return returnValue},Self.fixEvent=function(event){event.preventDefault=Self.fixEvent.preventDefault;event.stopPropagation=Self.fixEvent.stopPropagation;return event},Self.fixEvent.preventDefault=function(){this.returnValue=false},Self.fixEvent.stopPropagation=function(){this.cancelBubble=true},Self.addEvents=function(){Self.addEvent(document.body,"mousemove",Self.initFlip);Self.addEvent(document,"mouseout",function(e){var elem;e=e?e:window.event;var from=e.relatedTarget||e.toElement;if(!from||from.nodeName=="HTML"){Self.endFlip()}})},Self.hasClass=function(elem,className){return elem.className&&new RegExp("(^|\\s)"+className+"(\\s|$)").test(elem.className)},Self.closestElm=function(elem,selector,container){var container=container||document.body,firstChar=selector.charAt(0);while(elem&&elem!==container){if(firstChar==="."&&Self.hasClass(elem,selector.substr(1))){return elem}if(firstChar==="#"&&elem.id===selector.substr(1)){return elem}if(firstChar==="["&&elem.getAttribute(selector.substr(1,selector.indexOf("]")-1))){return elem}elem=elem.parentNode}return false},Self.dataSet=function(string){var data;try{data=eval("("+string+")")}catch(e){data=false}return data},Self.data=function(elem,key,val){elem.data=elem.data||{};switch(arguments.length){case 3:elem.data[key]=val;break;case 2:return elem.data[key];break;default:return elem.data}},Self.callbackData=function(){data={index:o.index,setLength:o.setLength,currentImage:o.currentImage,imgWrapper:o.imgWrapper,currentUrl:o.currentUrl,active:o.active,status:o.status};return data},Self.initFlip=function(e){var e=e||window.event,targetElement=e.target||e.srcElement;clearTimeout(flipTimer);flipTimer=window.setTimeout(function(){Self.startFlip(targetElement)},0)},Self.startFlip=function(targetElement){var targetElement=targetElement,i=0,len=Self.params.thumbnailsSets.length,digitsPreffix,digitsSuffix,firstThumbnail,setLength,incrementer,index,digits,meta,elem,img;if(o.active&&!Self.closestElm(targetElement,"[data-flipbook_active]")){Self.endFlip()}for(;i<len;i++){if(Self.closestElm(targetElement,Self.params.thumbnailsSets[i].thumbnailsContainer)&&((!Self.params.thumbnailsSets[i].extendHoverClassName&&Self.hasClass(targetElement,Self.params.thumbnailsSets[i].thumbnailsClassName))||(Self.params.thumbnailsSets[i].extendHoverClassName&&Self.closestElm(targetElement,"."+Self.params.thumbnailsSets[i].extendHoverClassName)))){elem=targetElement;img=targetElement;if(Self.params.thumbnailsSets[i].excludeContainer&&Self.closestElm(elem,Self.params.thumbnailsSets[i].excludeContainer)){return false}if(Self.params.thumbnailsSets[i].extendHoverClassName){elem=Self.closestElm(elem,"."+Self.params.thumbnailsSets[i].extendHoverClassName);img=elem.querySelector("."+Self.params.thumbnailsSets[i].thumbnailsClassName)}if(o.active){if(elem.getAttribute("data-flipbook_active")){return false}else{Self.endFlip()}}if(!Self.params.thumbnailsSets[i].cover){digitsPreffix=img.src.substring(0,img.src.lastIndexOf(Self.params.thumbnailsSets[i].digitsPreffix)+1);digits=img.src.replace(digitsPreffix,"");digitsSuffix=Self.params.thumbnailsSets[i].digitsSuffix;digits=parseInt(digits.replace(digitsSuffix,""),10);firstThumbnail=Self.params.thumbnailsSets[i].firstThumbnail;setLength=Self.params.thumbnailsSets[i].setLength;incrementer=Self.params.thumbnailsSets[i].incrementer;index=(digits-firstThumbnail)/incrementer}else{meta=Self.dataSet(img.getAttribute("data-flipbook"));setLength=meta.setLength;firstThumbnail=meta.firstThumbnail;digits=parseInt(meta.firstThumbnail,10)-meta.incrementer;digitsPreffix=meta.digitsPreffix;digitsSuffix=meta.digitsSuffix;incrementer=meta.incrementer;index=-1}o={index:index,setLength:setLength,currentUrl:img.src,firstThumbnail:firstThumbnail,digits:digits,digitsPreffix:digitsPreffix,digitsSuffix:digitsSuffix,incrementer:incrementer,currentImage:img,imgWrapper:false,interval:Self.params.thumbnailsSets[i].interval,active:true,callback:Self.params.thumbnailsSets[i].callback,init:Self.params.thumbnailsSets[i].init,status:"started"};elem.setAttribute("data-flipbook_active","1");if(Self.params.thumbnailsSets[i].extendHoverClassName){o.imgWrapper=elem}if(o.init&&!elem.init){Self.callbackData();o.init(data)}if(!elem.init){Self.data(elem,"oldThumbUrl",img.src);Self.data(elem,"oldIndex",index);elem.init=true}if(o.callback){Self.callbackData();o.callback(data)}if(Self.params.thumbnailsSets[i].resetIndex){o.digits=(setLength-1)*o.incrementer+parseInt(o.firstThumbnail,10);o.index=(setLength-1);Self.callbackData()}window.clearTimeout(timer);timer=window.setTimeout(Self.preload,0);return false}}},Self.endFlip=function(){var activeElm;window.clearTimeout(timer);if(o.active){activeElm=document.querySelector("[data-flipbook_active]");if(activeElm){activeElm.removeAttribute("data-flipbook_active");if(activeElm.nodeName==="IMG"){activeElm.src=Self.data(activeElm,"oldThumbUrl")}else{activeElm.querySelector("img").src=Self.data(activeElm,"oldThumbUrl")}}o.active=false;o.status="ended";o.index=Self.data(activeElm,"oldIndex");if(o.callback){Self.callbackData();o.callback(data)}}},Self.preload=function(){var tempImage=new Image();if(o.digits<(o.setLength-1)*o.incrementer+parseInt(o.firstThumbnail,10)){o.digits=o.digits+o.incrementer;o.index++}else{o.digits=parseInt(o.firstThumbnail,10);o.index=0}if(o.firstThumbnail.length>String(o.digits).length){o.currentUrl=o.digitsPreffix+o.firstThumbnail.substring(0,o.firstThumbnail.length-String(o.digits).length)+o.digits+o.digitsSuffix}else{o.currentUrl=o.digitsPreffix+o.digits+o.digitsSuffix}tempImage.onerror=function(){Self.endFlip()};tempImage.onload=function(){if(o.active){if(o.status!=="running"){timer=window.setTimeout(Self.flipImage,0)}else{timer=window.setTimeout(Self.flipImage,o.interval)}}};tempImage.src=o.currentUrl},Self.flipImage=function(index){window.clearTimeout(timer);o.currentImage.src=o.currentUrl;o.status="running";if(o.callback){Self.callbackData();o.callback(data)}if(typeof index!=="undefined"){o.digits=index*o.incrementer+parseInt(o.firstThumbnail,10);o.index=index;Self.callbackData()}Self.preload()},Self.jumpTo=function(index){o.digits=index*o.incrementer+parseInt(o.firstThumbnail,10);o.index=index;if(o.firstThumbnail.length>String(o.digits).length){o.currentUrl=o.digitsPreffix+o.firstThumbnail.substring(0,o.firstThumbnail.length-String(o.digits).length)+o.digits+o.digitsSuffix}else{o.currentUrl=o.digitsPreffix+o.digits+o.digitsSuffix}o.currentImage.src=o.currentUrl;if(o.callback){Self.callbackData();o.callback(data)}},Self.changeIndex=function(index){o.digits=index*o.incrementer+parseInt(o.firstThumbnail,10);o.index=index;Self.callbackData()},Self.pauseFlip=function(){window.clearTimeout(timer);o.status="paused"}};